image: registry.gitlab.com/modioab/base-image:fedora-24-build-latest

build-image:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
#    - docker login -u $BUILD_USER -p $BUILD_PASSWORD -e "autobuild@modio.se" registry.gitlab.com
    - cat /root/.docker/config.json
    - echo TOKEN '*****'
    - echo "$CI_BUILD_TOKEN"
    - docker info
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C build all


zabbix-web:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
#    - docker login -u $BUILD_USER -p $BUILD_PASSWORD -e "autobuild@modio.se" registry.gitlab.com
    - docker info
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C zabbix-web all


python3-image:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
#    - docker login -u $BUILD_USER -p $BUILD_PASSWORD -e "autobuild@modio.se" registry.gitlab.com
    - docker info
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - ./build-python-image.sh


arm-rootfs:
  image: registry.gitlab.com/modioab/base-image:debian-armv7-bootstrap
  # TODO: Replace bootstrap with below image
  # image: registry.gitlab.com/modioab/base-image:debian-armv7
  before_script: 
    - apt-get update
    - apt-get install -y -qq debootstrap
    - apt-get install -y -qq make  # TODO: remove this line

  stage: build
  tags: 
    - arm
  script:
    - make -C debian-armv7 rootfs
  artifacts:
    paths:
      - debian-armv7/rootfs.tar.gz

arm-container:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
#    - docker login -u $BUILD_USER -p $BUILD_PASSWORD -e "autobuild@modio.se" registry.gitlab.com
    - docker info
  stage: test # Because we want it in the stage after build
  tags: 
    - docker
    - x86_64
  dependencies:
    - arm-rootfs
  script:
    - make -C debian-armv7 build publish
