image: registry.gitlab.com/modioab/base-image:fedora-25-build-master
stages:
    - build
    - publish
    - deploy


build-image-24:build:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - docker info
    - make -C build-fedora-24 build
  artifacts:
    paths:
      - build-fedora-24/*-image.tar
    expire_in: 1 day


build-image-24:publish:
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - build-image-24:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C build-fedora-24 load publish


build-image-25:build:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - docker info
    - make -C build-fedora-25 build
  artifacts:
    paths:
      - build-fedora-25/*-image.tar
    expire_in: 1 day


build-image-25:publish:
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - build-image-25:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C build-fedora-25 load publish


build-image-26:build:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - docker info
    - make -C build-fedora-26 build
  artifacts:
    paths:
      - build-fedora-26/*-image.tar
    expire_in: 1 day


build-image-26:publish:
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - build-image-26:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C build-fedora-26 load publish


zabbix-web:build:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - docker info
    - make -C zabbix-web build
  artifacts:
    paths:
      - zabbix-web/*-image.tar
    expire_in: 1 day


zabbix-web:publish:
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - zabbix-web:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C zabbix-web load publish


python3-image-25:build:
  image: registry.gitlab.com/modioab/base-image:fedora-25-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C python3-image build
  artifacts:
    paths:
      - python3-image/fedora-25-python-image.tar
    expire_in: 1 day


python3-image-25:publish:
  image: registry.gitlab.com/modioab/base-image:fedora-25-build-master
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - python3-image-25:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C python3-image load publish


python3-image-24:build:
  image: registry.gitlab.com/modioab/base-image:fedora-24-build-latest
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C python3-image build
  artifacts:
    paths:
      - python3-image/fedora-24-python-image.tar
    expire_in: 1 day


python3-image-24:publish:
  image: registry.gitlab.com/modioab/base-image:fedora-24-build-latest
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - python3-image-24:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C python3-image load publish


debian-armv7:build:
  image: registry.gitlab.com/modioab/base-image:debian-armv7-bootstrap
  # TODO: Replace bootstrap with below image
  # image: registry.gitlab.com/modioab/base-image:debian-armv7
  before_script:
    - sed -i s:httpredir:ftp.nl:g /etc/apt/sources.list
    - apt-get clean
    - apt-get update
    - apt-get install -y -qq debootstrap
    - apt-get install -y -qq make  # TODO: remove this line
  stage: build
  tags:
    - arm
  script:
    - make -C debian-armv7 rootfs
  artifacts:
    paths:
      - debian-armv7/rootfs.tar
    expire_in: 1 day


debian-armv7:publish:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - docker info
  stage: publish # Because we want it in the stage after build
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - debian-armv7:build
  script:
    - make -C debian-armv7 build
    - make -C debian-armv7 publish


nodejs-image-26:build:
  image: registry.gitlab.com/modioab/base-image:fedora-26-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C nodejs-image build
  artifacts:
    paths:
      - nodejs-image/fedora-26-nodejs-image.tar
    expire_in: 1 day


nodejs-image-26:publish:
  image: registry.gitlab.com/modioab/base-image:fedora-26-build-master
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - nodejs-image-26:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C nodejs-image load publish


nginx-26:build:
  image: registry.gitlab.com/modioab/base-image:fedora-26-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C nginx build
  artifacts:
    paths:
      - nginx/fedora-26-nginx-image.tar
    expire_in: 1 day


nginx-26:publish:
  image: registry.gitlab.com/modioab/base-image:fedora-26-build-master
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - nginx-26:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C nginx load publish


meteor-image-26:build:
  image: registry.gitlab.com/modioab/base-image:fedora-26-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C meteor-fedora-26 build
  artifacts:
    paths:
      - meteor-fedora-26/fedora-26-meteor-image.tar
    expire_in: 1 day


meteor-image-26:publish:
  image: registry.gitlab.com/modioab/base-image:fedora-26-build-master
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - meteor-image-26:build
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C meteor-fedora-26 load publish


trigger_build:
    stage: deploy
    dependencies: []
    script:
        - curl -X POST -F token=$API_KEY        -F ref=master https://gitlab.com/api/v3/projects/1282148/trigger/builds
        - curl -X POST -F token=$SUBMIT_KEY     -F ref=master https://gitlab.com/api/v3/projects/1282147/trigger/builds
        - curl -X POST -F token=$CONTAINER_KEY  -F ref=master https://gitlab.com/api/v3/projects/1528552/trigger/builds
