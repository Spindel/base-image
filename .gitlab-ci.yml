---
image: registry.gitlab.com/modioab/base-image/fedora-31/container:master
stages:
  - first
  - promote
  - second
  - build
  - publish
  - deploy

variables:
    # Podman defaults to OCI images, since 2019-02-15+ onwards, gitlab registry
    # fails to work properly with the default `oci` images.
    # TODO: Test & bug-report this
    BUILDAH_FORMAT: docker

before_script:
  - make -f build.mk login
  - podman ${BUILDAH_RUNTIME+--runtime} ${BUILDAH_RUNTIME} info


container:f31:
  stage: second
  tags:
    - x86_64
  variables:
    FEDORA_ROOT_RELEASE: '31'
  rules:
    # - changes:
    #     - .gitlab-ci.yml
    #     - build.mk
    #     - container/**/*
    # - if: '$CI_COMMIT_BRANCH == "master"'
    # - when: never
  script:
    - make -C container build publish
  artifacts:
    paths:
      - container/image.tar


container:promote:
  stage: promote
  image: registry.gitlab.com/modioab/base-image/fedora-31/container:container-test-build
  tags:
    - x86_64
  rules:
    # - if: '$CI_COMMIT_BRANCH == "master"'
    # - when: never
  needs:
    - job: container:f31
      artifacts: true
  variables:
  script:
    - make -C container IMAGE_ARCHIVE=dummy.tar build
    - make -C container IMAGE_TAG_SUFFIX=leetest publish


# build-image:f31:
#   stage: build
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - build-fedora-31/**/*
#   script:
#     - make -C build-fedora-31 build-publish


# python3:f31:
#   stage: second
#   tags:
#     - x86_64
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - python3-image/**/*
#   script:
#     - make -C python3-image build-publish

# jstest:f31:
#   stage: second
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - jstest/**/*
#   script:
#     - make -C jstest build-publish


# debian9-cross:
#   stage: build
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - debian9-cross/**/*
#   script:
#     - make -C debian9-cross build-publish


# debian9-firmware:
#   stage: build
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - debian9-firmware/**/*
#   script:
#     - make -C debian9-firmware build-publish


# debian10-firmware:
#   stage: build
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - debian10-firmware/**/*
#   script:
#     - make -C debian10-firmware build-publish


# nodejs:f31:
#   stage: second
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - nodejs-image/**/*
#   script:
#     - make -C nodejs-image build-publish


# nginx:f31:
#   stage: second
#   tags:
#     - x86_64
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - nginx/**/*
#   script:
#     - make -C nginx build-publish


# meteor-1.10:f31:
#   stage: second
#   tags:
#     - x86_64
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#     METEOR_RELEASE: '1.10.1'
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - meteor-image/**/*
#   script:
#     - make -C meteor-image build-publish

# meteor-1.8.2:f31:
#   stage: second
#   tags:
#     - x86_64
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#     METEOR_RELEASE: '1.8.2'
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - meteor-image/**/*
#   script:
#     - make -C meteor-image build-publish


# c-image:f31:
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#   stage: second
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - c-image/**/*
#   script:
#     - make -C c-image build-publish


# go-image:f31:
#   stage: second
#   variables:
#     FEDORA_ROOT_RELEASE: '31'
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - go-image/**/*
#   script:
#     - make -C go-image build-publish


# rust-cross:
#   stage: build
#   tags:
#     - x86_64
#   only:
#     changes:
#       - .gitlab-ci.yml
#       - build.mk
#       - rust-cross/**/*
#   script:
#     - make -C rust-cross build-publish


# trigger_build:
#   before_script:
#     - 'true'
#   stage: deploy
#   only:
#     - master
#   dependencies: []
#   script:
#     - curl -X POST -F token=$API_KEY          -F ref=master
#            https://gitlab.com/api/v4/projects/1282148/trigger/pipeline
#     - curl -X POST -F token=$SUBMIT_KEY       -F ref=master
#            https://gitlab.com/api/v4/projects/1282147/trigger/pipeline
#     - curl -X POST -F token=$CONTAINER_KEY    -F ref=master
#            https://gitlab.com/api/v4/projects/1528552/trigger/pipeline
#     - curl -X POST -F token=$HOUSEKEEPER_KEY  -F ref=master
#            https://gitlab.com/api/v4/projects/5299264/trigger/pipeline
#     - curl -X POST -F token=$SSHCA_KEY        -F ref=master
#            https://gitlab.com/api/v4/projects/7519281/trigger/pipeline
#     - curl -X POST -F token=$JOURNAL_GELF_KEY -F ref=master
#            https://gitlab.com/api/v4/projects/9359556/trigger/pipeline
#     - curl -X POST -F token=$SYSADMIN_KEY     -F ref=master
#            https://gitlab.com/api/v4/projects/1274252/trigger/pipeline
