image: registry.gitlab.com/modioab/base-image/container:new-container-image
stages:
    - first
    - second
    - build
    - publish
    - deploy

before_script:
    - make -f build.mk login
    - "docker info ||:"
    - "podman info ||:"

container:28:
  stage: second
  tags:
  - x86_64
  variables:
          FEDORA_ROOT_RELEASE: '28'
  script:
  - make -C container build-publish

build-image-27:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C build-fedora-27 build-publish

build-image-28:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C build-fedora-28 build-publish


zabbix-web:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C zabbix-web build-publish

python3-image-28:
  stage: second
  tags:
    - docker
    - x86_64
  variables:
          FEDORA_ROOT_RELEASE: '28'
  script:
    - make -C python3-image build-publish


python3-image-27:
  stage: second
  tags:
    - docker
    - x86_64
  variables:
          FEDORA_ROOT_RELEASE: '27'
  script:
    - make -C python3-image build-publish


debian8-firmware:
    stage: build
    tags:
        - docker
        - x86_64
    script:
      - make -C debian8-firmware build-publish

debian9-firmware:
    stage: build
    tags:
        - docker
        - x86_64
    script:
      - make -C debian9-firmware build-publish

debian-armv7:build:
  image: registry.gitlab.com/modioab/base-image:debian-armv7-new-container-image
  #  image: arm32v7/debian
  #  image: registry.gitlab.com/modioab/base-image/bootstrap:debian-armv7
  # TODO: Replace bootstrap with below image
  # image: registry.gitlab.com/modioab/base-image:debian-armv7
  before_script:
    - sed -i s:httpredir:ftp.nl:g /etc/apt/sources.list
    - apt-get clean
    - apt-get update
    - apt-get install -y -qq debootstrap
    - apt-get install -y -qq make  # TODO: remove this line
  stage: first
  tags:
    - arm
  script:
    - make -C debian-armv7 rootfs.tar
  artifacts:
    paths:
      - debian-armv7/rootfs.tar
    expire_in: 1 day


debian-armv7:publish:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - docker info
  stage: publish # Because we want it in the stage after build
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - debian-armv7:build
  script:
    - make -C debian-armv7 build-publish


rust-armv7:build:
  image: registry.gitlab.com/modioab/base-image:debian-armv7-master
  before_script:
    - apt-get clean
    - apt-get update
    - apt-get install -y -qq debootstrap
  stage: build
  tags:
    - arm
  script:
    - make -C rust-armv7 rootfs.tar
  artifacts:
    paths:
      - rust-armv7/rootfs.tar
    expire_in: 1 day


rust-armv7:publish:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - docker info
  stage: publish # Because we want it in the stage after build
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - rust-armv7:build
  script:
    - make -C rust-armv7 build-publish



nodejs-image-27:
  image: registry.gitlab.com/modioab/base-image:fedora-27-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C nodejs-image build-publish


nodejs-image-28:
  image: registry.gitlab.com/modioab/base-image:fedora-28-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C nodejs-image build-publish


nginx-27:
  stage: second
  tags:
    - docker
    - x86_64
  variables:
          FEDORA_ROOT_RELEASE: "27"
  script:
    - make -C nginx build-publish

nginx-28:
  stage: second
  tags:
    - docker
    - x86_64
  variables:
          FEDORA_ROOT_RELEASE: "27"
  script:
    - make -C nginx build-publish

mongodb:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C mongodb build-publish

meteor-image-27:
  image: registry.gitlab.com/modioab/base-image:fedora-27-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C meteor-fedora-27 build-publish


c-image-27:
  variables:
          FEDORA_ROOT_RELEASE: "27"
  stage: second
  tags:
    - docker
    - x86_64
  script:
    - make -C c-image build-publish

c-image-28:
  variables:
          FEDORA_ROOT_RELEASE: "28"
  stage: second
  tags:
    - docker
    - x86_64
  script:
    - make -C c-image build-publish

go-image-27:
  stage: second
  variables:
          FEDORA_ROOT_RELEASE: "27"
  tags:
    - docker
    - x86_64
  script:
    - make -C go-image build-publish

go-image-28:
  stage: second
  variables:
          FEDORA_ROOT_RELEASE: "28"
  tags:
    - docker
    - x86_64
  script:
    - make -C go-image build-publish


rust-cross:
  image: registry.gitlab.com/modioab/base-image:fedora-28-build-master
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C rust-cross build-publish


trigger_build:
    before_script:
        - "true"
    stage: deploy
    only:
        - master
    dependencies: []
    script:
        - curl -X POST -F token=$API_KEY        -F ref=master https://gitlab.com/api/v3/projects/1282148/trigger/builds
        - curl -X POST -F token=$SUBMIT_KEY     -F ref=master https://gitlab.com/api/v3/projects/1282147/trigger/builds
        - curl -X POST -F token=$CONTAINER_KEY  -F ref=master https://gitlab.com/api/v3/projects/1528552/trigger/builds
        - curl -X POST -F token=$HOUSEKEEPER_KEY -F ref=master https://gitlab.com/api/v4/projects/5299264/trigger/pipeline
