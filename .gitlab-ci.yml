image: registry.gitlab.com/modioab/base-image:fedora-24-build-latest
stages:
    - build
    - publish

build-image:build:
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - docker info
    - make -C build build
  artifacts:
    paths:
      - build/*-image.tar.gz
    expire_in: 1 hour


build-image:publish:
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" registry.gitlab.com
    - make -C build publish
  dependencies:
    - build-image:build


zabbix-web:build:
  before_script:
    - docker info
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C zabbix-web build


zabbix-web:publish:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  script:
    - make -C zabbix-web publish


python3-image:build:
  before_script:
    - docker info
  stage: build
  tags:
    - docker
    - x86_64
  script:
    - make -C python3-image rootfs
  artifacts:
    paths:
    - python3-image/rootfs.tar.gz


python3-image:publish:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
  stage: publish
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
      - python3-image:build
  script:
    - make -C python3-image build
    - make -C python3-image publish


debian-armv7:build:
  image: registry.gitlab.com/modioab/base-image:debian-armv7-bootstrap
  # TODO: Replace bootstrap with below image
  # image: registry.gitlab.com/modioab/base-image:debian-armv7
  before_script:
    - apt-get update
    - apt-get install -y -qq debootstrap
    - apt-get install -y -qq make  # TODO: remove this line
  stage: build
  tags:
    - arm
  script:
    - make -C debian-armv7 rootfs
  artifacts:
    paths:
      - debian-armv7/rootfs.tar.gz


debian-armv7:publish:
  before_script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" -e "autobuild@modio.se" registry.gitlab.com
    - docker info
  stage: publish # Because we want it in the stage after build
  when: always
  tags:
    - docker
    - x86_64
  dependencies:
    - debian-armv7:build
  script:
    - make -C debian-armv7 build 
    - make -C debian-armv7 publish
