%YAML 1.1
---
# Keep the includes first to illustrate that definitions that everything that
# follows override included definitions.
include:
  - file: /ci/default.yml
    project: ModioAB/CI
    ref: main
  - file: /ci/container.yml
    project: ModioAB/CI

variables:
  # Hard-code the container image to use one that we know already exists
  CONTAINER_IMAGE: registry.gitlab.com/modioab/base-image/fedora-35/container:master

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# The default settings above can be overriden in any of the jobs that follow

.container:build-publish:
  extends:
    - .container:build
  # /CI/container uses a hard-coded image, instead of using the variable as
  # defined in /CI/default, so we can't just override the variable for now.
  # TODO: https://gitlab.com/ModioAB/CI/-/issues/1
  image: ${CONTAINER_IMAGE}
  script:
    - make ${SUBDIR:+--directory=}${SUBDIR} login
    - podman info
    - make ${SUBDIR:+--directory=}${SUBDIR} build-publish

.fedora-release-matrix:
  parallel:
    matrix:
      - &fedora-root-release
        FEDORA_ROOT_RELEASE:
          - 35
          - 36


# Bootstrap can be run by setting FEDORA_ROOT_RELEASE in the variables part
# when running a pipeline manually.
bootstrap:
  extends:
    - .container:build-publish
  stage: prepare
  rules:
    - if: '"${FEDORA_ROOT_RELEASE}" != ""'
      when: manual
      allow_failure: true
    - when: never
  variables:
    SUBDIR: bootstrap


fedora:build-image:
  extends:
    - .container:build-publish
    - .fedora-release-matrix
  variables:
    SUBDIR: build-fedora


fedora:container:
  extends:
    - .container:build-publish
    - .fedora-release-matrix
  script:
    - make --directory=container login
    - podman info
    - make --directory=container build test publish


fedora:jstest:
  extends:
    - .container:build-publish
    - .fedora-release-matrix
  needs:
    - fedora:build-image
  variables:
    BASE_IMAGE_TAG: ${CI_COMMIT_REF_NAME}
    SUBDIR: jstest


fedora:
  extends:
    - .container:build-publish
  parallel:
    matrix:
      - <<: *fedora-root-release
        SUBDIR:
          - c-image
          - go-image
          - nginx
          - nodejs-image
          - python3-image

      - <<: *fedora-root-release
        SUBDIR:
          - meteor-image
        METEOR_RELEASE:
          - '1.10.1'


other:
  extends:
    - .container:build-publish
  parallel:
    matrix:
      - SUBDIR:
          - debian9-cross
          - debian9-firmware
          - debian10-firmware
          - rust
          - rust-cross
...
